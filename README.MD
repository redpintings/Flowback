<div align="center">
    <h1>Backflow</h1>
</div>

<div align="center">
    <a href="https://github.com/redpintings/Flowback">
        <img alt="GitHub Actions Workflow Status" src="https://image.dzplus.dzng.com/2025/01/09/17364137282465.jpg" />
    </a>
</div>

<div align="center">
    <a href="https://pypi.org/project/backflow/">
        <img alt="PyPI Version" src="https://image.dzplus.dzng.com/2024/06/06/17176696807966.jpg" />
    </a>
    <a href="https://github.com/redpintings/Flowback/issues">
        <img alt="GitHub Issues" src="https://image.dzplus.dzng.com/2024/06/06/17176697207099.jpg" />
    </a>
    <a href="https://github.com/redpintings/Flowback">
        <img alt="GitHub Repository" src="https://image.dzplus.dzng.com/2024/06/06/17176697507539.jpg" />
    </a>
</div>

Backflow æ˜¯ä¸€ä¸ªç®€æ´ä¸”çµæ´»çš„çˆ¬è™«æ¡†æ¶ï¼Œæ”¯æŒä½¿ç”¨ Celery å®ç°åˆ†å¸ƒå¼çˆ¬å–ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç¼–å†™çˆ¬è™«ä»£ç ï¼Œå¹¶ä¸”æ¡†æ¶æä¾›äº†ä¸°å¯Œçš„é…ç½®é€‰é¡¹å’Œæ‰©å±•èƒ½åŠ›ã€‚

## ç›®å½•

- [ğŸ¯ åŠŸèƒ½](#åŠŸèƒ½)
- [ğŸ’» è¿è¡Œå¹³å°](#è¿è¡Œå¹³å°)
- [ğŸ”§ è¿è¡Œç¯å¢ƒ](#è¿è¡Œç¯å¢ƒ)
- [ğŸƒâ€ Quick Start](#quick-start)
    - [å®‰è£…ä¾èµ–](#å®‰è£…ä¾èµ–)
    - [ä¿®æ”¹é…ç½®æ–‡ä»¶](#ä¿®æ”¹é…ç½®æ–‡ä»¶)
    - [è¿è¡Œç¨‹åº](#è¿è¡Œç¨‹åº)
    - [åˆ†å¸ƒå¼è¿è¡Œ](#åˆ†å¸ƒå¼è¿è¡Œ)
    - [æ·»åŠ æ–°çˆ¬è™«](#æ·»åŠ æ–°çˆ¬è™«)
- [ğŸ’¼ æœåŠ¡å™¨é…ç½®](#æœåŠ¡å™¨é…ç½®)
- [ğŸ•·ï¸ çˆ¬è™«ä»£ç æ¨¡æ¿](#çˆ¬è™«ä»£ç æ¨¡æ¿)
- [ğŸ‘¨ æ¡†æ¶è¿è¡Œæ­¥éª¤](#æ¡†æ¶è¿è¡Œæ­¥éª¤)
- [â“ æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)

## åŠŸèƒ½

- æ”¯æŒå•æœºå¤šçº¿ç¨‹çˆ¬å–
- æ”¯æŒåˆ†å¸ƒå¼çˆ¬å–ï¼ˆåŸºäº Celeryï¼‰
- çµæ´»çš„é…ç½®é€‰é¡¹
- æ˜“äºæ‰©å±•çš„çˆ¬è™«æ¨¡æ¿

## è¿è¡Œå¹³å°

- [x] Linux
- [x] macOS
- [x] Windows

## è¿è¡Œç¯å¢ƒ

- Python 3.9+
- Linux / Windows

## Quick Start

### å®‰è£…ä¾èµ–

```bash
pip install backflow
```

#### ä¿®æ”¹é…ç½®æ–‡ä»¶conf And settings

```yaml
celery:
  host: 127.0.0.1
  port: 27017
  xxxx: xxxx

es:
  host: 127.0.0.1
  port: 9200
...

```

#### è¿è¡Œç¨‹åº

```bash
# æŸ¥çœ‹å‘½ä»¤å¸®åŠ©
backflow --help
# æŸ¥çœ‹ç›®å‰æ‰€æœ‰çš„å›æµå¹³å°çš„çˆ¬è™«åˆ—è¡¨
backflow list
# è¿è¡Œå•ä¸ªçˆ¬è™«
backflow crawl baijiahao  # Single run
backflow crawl jinritoutiao  # Single run

# Single run  The default is 20 pages. If you want to set page numbers, use the --page parameter
# For detailed parameters, please refer to the default parameter START_PAGE END_PAGE PAGE_STEP in settings.py
backflow crawl baijiahao --page 4  
# è¿è¡Œæ‰€æœ‰çˆ¬è™« å¤šçº¿ç¨‹å•æœºè¿è¡Œ
# main_back.py  # Can run all crawlers

```

#### åˆ†å¸ƒå¼è¿è¡Œ Execute Cellery Distributed

```bash
 # å¯åŠ¨celery worker
celery -A tasks worker --loglevel=info 

# run distributed command / åˆ†å¸ƒå¼è¿è¡Œ
backflow crawl baijiahao --distributed

# if you need to specify the number of pages for a distributed crawler, 100 pages, and a step size of 10
backflow crawl baijiahao --distributed --page 100 --step 10

```

#### æ·»åŠ æ–°çˆ¬è™« æ–°å¢åä¸ºnewspiderçš„çˆ¬è™«

```bash
# add new spider
backflow addspider newspider

```


### æ¨¡ç‰ˆçˆ¬è™«ä»£ç 

  > å½“ä½ ä½¿ç”¨å‘½ä»¤`backflow addspider newspider`åˆ›å»ºå¥½ä¸€ä¸ªæ–°çš„spideræ¨¡ç‰ˆåï¼Œè¯·ç¡®ä¿ä½ çš„çˆ¬è™«ä»£ç è¯·æ±‚ å¯ä»¥æ­£ç¡®é‡‡é›†åˆ°æ•°æ®

```python
from loguru import logger
from utils.tools import Tools
from Backflows.base import BackFlow
from Backflows.middleware import Request
import traceback


class {spider_name.capitalize()}(BackFlow):
    name = '{spider_name}'

    def __init__(self):
        super().__init__()
        self.ck = None
        self.headers = {{
            "user-agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like "
                          "Gecko) Chrome/108.0.0.0 Safari/537.36"
        }}

    async def get_page_request(self, page):
        url = 'http://example.com/api/data?page={{}}'.format(page)
        return Request('GET', url=url, headers=self.headers, cookies=self.ck, meta={{'page': page}})

    async def parse(self, response):

        resp = response.json()
        datas = resp.get('data', {{}})
        if not datas:
            print(f'{spider_name} cookie might be expired or no data returned.')
            return
        for con in datas:
            news = {{
                'url': con.get('item_id', ''),
            }}
            yield news

```

### æ­£å¼æœåŠ¡å™¨é…ç½®

```yaml
server:
  120.xx.xx.249

demo server:
  host: 120.xx.xx.249
  path: /opt/workstation/xx/

å®šæ—¶ä»»åŠ¡:
  crontab/supervisor

```
### æ¡†æ¶è¿è¡Œæ­¥éª¤


1. **å¯åŠ¨ç¨‹åº**ï¼š
   åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ`runner.py`ï¼Œå¹¶ä¼ å…¥ç›¸åº”çš„å‚æ•°ï¼Œä¾‹å¦‚çˆ¬è™«çš„åç§°ã€æ˜¯å¦ä»¥åˆ†å¸ƒå¼æ¨¡å¼è¿è¡Œã€åœæ­¢é¡µç å’Œæ­¥é•¿ã€‚

2. **å‘½ä»¤è¡Œè§£æ**ï¼š
   `argparse`åº“è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå¹¶æ ¹æ®å‚æ•°ç¡®å®šè¿è¡Œæ¨¡å¼ã€‚

3. **æŸ¥æ‰¾çˆ¬è™«**ï¼š
   `SpiderRunner`ç±»çš„`find_spiders`æ–¹æ³•æœç´¢æ‰€æœ‰å·²å®šä¹‰çš„çˆ¬è™«æ¨¡å—ï¼ˆå¦‚`spiders`ï¼‰ï¼Œå¹¶å¯¼å…¥è¿™äº›æ¨¡å—ã€‚å®ƒæŸ¥æ‰¾æ‰€æœ‰ç»§æ‰¿è‡ª`BackFlow`ç±»çš„çˆ¬è™«ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ä¸€ä¸ªå­—å…¸ä¸­ï¼Œé”®ä¸ºçˆ¬è™«çš„åç§°ã€‚

4. **åŠ è½½ä¸­é—´ä»¶&&Settings**ï¼š
   `load_middlewares`æ–¹æ³•æ ¹æ®`settings.MIDDLEWARES`é…ç½®åŠ è½½ä¸­é—´ä»¶ã€‚ä¸­é—´ä»¶åŒ…æ‹¬ç”¨æˆ·ä»£ç†ã€é‡è¯•å’Œä»£ç†ä¸­é—´ä»¶ï¼Œå®ƒä»¬ç”¨äºä¿®æ”¹è¯·æ±‚å’Œå¤„ç†å“åº”ã€‚

5. **è¿è¡Œçˆ¬è™«**ï¼š
   å¦‚æœé€‰æ‹©äº†åˆ†å¸ƒå¼æ¨¡å¼ï¼Œ`run`æ–¹æ³•ä¼šä¸ºæ¯ä¸ªé¡µé¢ç”Ÿæˆä¸€ä¸ª`run_spider`ä»»åŠ¡ï¼Œå¹¶ä½¿ç”¨Celeryå°†å…¶æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚å¦åˆ™ï¼Œå®ƒä¼šä¸ºæ¯ä¸ªé¡µé¢åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶ä½¿ç”¨`asyncio.gather`ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚

6. **æ‰§è¡Œä»»åŠ¡**ï¼š
   åœ¨åˆ†å¸ƒå¼æ¨¡å¼ä¸‹ï¼ŒCelery workerä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œã€‚æ¯ä¸ªä»»åŠ¡éƒ½ä¼šè°ƒç”¨`async_run_spider`å¼‚æ­¥å‡½æ•°ã€‚

7. **è·å–é¡µé¢è¯·æ±‚**ï¼š
   `async_run_spider`å‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ª`Page`å¯¹è±¡ï¼Œå¹¶è°ƒç”¨çˆ¬è™«çš„`get_page_request`æ–¹æ³•æ¥è·å–è¯¥é¡µé¢çš„è¯·æ±‚å¯¹è±¡ã€‚

8. **å¤„ç†è¯·æ±‚**ï¼š
   `process_request`æ–¹æ³•ä½¿ç”¨ä¸­é—´ä»¶å¤„ç†è¯·æ±‚ï¼Œä¾‹å¦‚æ·»åŠ ç”¨æˆ·ä»£ç†ã€è®¾ç½®ä»£ç†ç­‰ã€‚

9. **æŠ“å–é¡µé¢**ï¼š
   `fetch_page`æ–¹æ³•ä½¿ç”¨`httpx.AsyncClient`å‘é€è¯·æ±‚å¹¶è·å–å“åº”ã€‚å®ƒä½¿ç”¨ä¿¡å·é‡æ¥é™åˆ¶å¹¶å‘è¯·æ±‚æ•°é‡ã€‚

10. **å¤„ç†å“åº”**ï¼š
    `process_response`æ–¹æ³•ä½¿ç”¨ä¸­é—´ä»¶å¤„ç†å“åº”ï¼Œä¾‹å¦‚æ£€æŸ¥å“åº”çŠ¶æ€ç ã€‚

11. **è§£æé¡µé¢**ï¼š
    çˆ¬è™«çš„`parse`æ–¹æ³•è§£æå“åº”å†…å®¹ï¼Œæå–æ•°æ®é¡¹ã€‚å¯¹äºæ¯ä¸ªæå–çš„æ•°æ®é¡¹ï¼Œå®ƒä¼šè°ƒç”¨ç®¡é“çš„`process_item`æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚

12. **ç®¡é“å¤„ç†æ•°æ®é¡¹**ï¼š
    Pipelineçš„`process_item`æ–¹æ³•å°†æ•°æ®é¡¹å­˜å‚¨åˆ°MongoDBæˆ–æ–‡ä»¶ä¸­ã€‚

13. **ç»Ÿè®¡ä¿¡æ¯**ï¼š
    çˆ¬è™«ä¼šæ›´æ–°å·²æŠ“å–é¡µé¢æ•°å’Œå·²å‘é€è¯·æ±‚æ•°ã€‚åœ¨æ‰€æœ‰é¡µé¢æŠ“å–å®Œæˆåï¼Œ`print_stats`æ–¹æ³•ä¼šæ‰“å°è¿™äº›ç»Ÿè®¡ä¿¡æ¯ã€‚

14. **é”™è¯¯å¤„ç†**ï¼š
    å¦‚æœä»»ä½•æ­¥éª¤å‡ºç°é”™è¯¯ï¼Œå¼‚å¸¸ä¼šè¢«æ•è·ï¼Œé”™è¯¯ä¿¡æ¯ä¼šè¢«è®°å½•ï¼Œå¹¶é€šè¿‡é’‰é’‰å‘é€é€šçŸ¥ã€‚


### æ³¨æ„äº‹é¡¹

- æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œæœªç»æœ¬åœ°æµ‹è¯• è¯·ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
- åˆ†å¸ƒå¼è¿è¡Œéœ€è¦å¯åŠ¨celery workerã€‚
- restart_celery.py è„šæœ¬ç”¨äºç›‘æ§å¹¶é‡å¯celery workerã€‚éœ€è¦åœ¨supervisorä¸­é…ç½®æˆ–è€… ç›´æ¥è¿è¡Œ
- çˆ¬è™«ä»£ç éœ€è¦åœ¨backflow/spidersç›®å½•ä¸‹ã€‚
- çˆ¬è™«é…ç½®æ–‡ä»¶éœ€è¦åœ¨backflow/confç›®å½• å’Œ backflow/settings.pyä¸­é…ç½®ã€‚